<!DOCTYPE html>
<html>
  <head>
    <title> Collect Data for Signature Verification </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js" integrity="sha384-lp4k1VRKPU9eBnPePjnJ9M2RF3i7PC30gXs70+elCVfgwLwx1tv5+ctxdtwxqZa7" crossorigin="anonymous"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script>
function encrypt(unencrypted, passphrase){
	var encrypted = CryptoJS.AES.encrypt(unencrypted, passphrase);
  	var hmac = CryptoJS.HmacSHA256(encrypted.toString(), CryptoJS.SHA256(passphrase).toString()).toString();
  	var encryptedMsg = hmac + encrypted;
  	return encryptedMsg;
}
function decrypt(encryptedMsg, passphrase){
    var encryptedHMAC = encryptedMsg.substring(0, 64),
    encryptedHTML = encryptedMsg.substring(64),
    decryptedHMAC = CryptoJS.HmacSHA256(encryptedHTML, CryptoJS.SHA256(passphrase).toString()).toString();

    if (decryptedHMAC !== encryptedHMAC) {
        //alert('Bad passphrase !');
        return null;
    }
    var ret = CryptoJS.AES.decrypt(encryptedHTML, passphrase).toString(CryptoJS.enc.Utf8);
    return ret;
}

function setCookie(cname, cvalue, exhrs) {
    var d = new Date();
    d.setTime(d.getTime() + (exhrs*60*60*1000));
    var expires = "expires="+ d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/;";
}
function getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for(var i = 0; i <ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

function getStamp(){
  var d = new Date();
  return d.toUTCString();
}

function get_json(url, handle, onerror){

  // var xhr = new XMLHttpRequest();
  // xhr.onreadystatechange = function() {
  //   if (this.readyState == XMLHttpRequest.DONE){
  //     if(this.status == 200 || this.status == 0){
  //       handle(this.responseText);
  //     } else{
  //       typeof onerror == 'undefined'? console.log('Not successful!', this.status):
  //         onerror(this.responseText);
  //     }
  //    };
  // }

  // xhr.open("GET", url, true);
  // xhr.send();

	$.ajax({
		url: url,
		type: 'GET',
		dataType: '*'
	}).done(handle).fail(function(e){
		console.log(e)
		//alert("Access Denied!")
	})
}


var prefill_str = "entry.734324363=ID&entry.980529461=TYPE&entry.466105486=DATA&entry.1069261603=STAMP";
prefill = prefill_str.split('&');
var entry = {};
for(var i in prefill){
	var j = prefill[i].split('=');
	entry[j[1]] = j[0];
}

function submit_one(formId, ID,TYPE,DATA,STAMP, onsuccess, onerror){
	
	var posturl = 'https://docs.google.com/forms/d/e/' + formId + '/formResponse';
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function() {
    if (this.readyState == XMLHttpRequest.DONE){
			if(this.status == 200 || this.status == 0){
        typeof onsuccess == 'undefined'? console.log('sent', DATA.length):
          onsuccess();
			} else{
        typeof onerror == 'undefined'? console.log('Not successful!', this.status, key, value, id):
          onerror();
	    }
     };
  }

	xhr.open("POST", posturl, true);
  var data = {};
	data[entry.ID] = ID;
  data[entry.TYPE] = TYPE;
  data[entry.DATA] = DATA;
  data[entry.STAMP] = STAMP;
  data['submit'] = 'Submit';
	var fd = new FormData();
	for(var item in data){
		fd.append(item, data[item]);
	}

  xhr.send(fd);
	
}


function get_target(sheetId, row, column, handle){
  var cell = 'R' + row + 'C' + column;
  var geturl = "https://spreadsheets.google.com/feeds/cells/" + sheetId 
  + "/2/public/values/"+ cell + "?alt=json";
  get_json(geturl, handle);
}

function register(el, evts){
	for(var type in evts){
	  el.addEventListener(type, evts[type]);
	}
}

function selector(){
	var pressed = false;
	var signature = [];
	var boundary = [];
	var boxP1 = {};
	var boxP2 = {};
	var lastPos = {};

  function updateBoundary(x,y){
    var dx = x - lastPos.x;
    var dy = y - lastPos.y;
    if(dx == 0 && dy == 0){
      return;
    }

    // connect
    if(dx*dx > 1 && dy*dy<=dx*dx){
      var step = dx>0? 1: -1;
      var r = dy/dx;

      for(var j=1;j<dx/step;++j){
        boundary.push({x:lastPos.x+step*j, y:lastPos.y+Math.floor(step*j*r)});
      }
    }else if(dy*dy > 1 && dy*dy>=dx*dx){
      var step = dy>0? 1: -1;
      var r = dx/dy;
      for(var j=1;j<dy/step;++j){
        boundary.push({x:lastPos.x+Math.floor(step*j*r), y:lastPos.y+step*j});
      }
    }
    lastPos = {x:x, y:y};
    boundary.push(lastPos);

    // update bounding box, for resizing the signature
    if(x < boxP1.x){
      boxP1.x = x;
    }else if(x > boxP2.x){
      boxP2.x = x;
    }
    if(y < boxP1.y){
      boxP1.y = y;
    }else if(y > boxP2.y){
      boxP2.y = y;
    }

  }

  function pressing(offsetX, offsetY){
    if(pressed){
      return false;
    }
    boundary = [];
    lastPos = {x:offsetX, y:offsetY};
    boundary.push(lastPos);
    boxP1 = {x:offsetX, y:offsetY};
    boxP2 = {x:offsetX, y:offsetY};
    pressed = true;
    return true;
  }

  function release(e){
    if(!pressed){
      return false;
    }
    //updateBoundary(boundary[0].x, boundary[0].y); // back to the staring point
    pressed = false;

    signature.push(boundary);

    return {
      boundary: boundary,
      boxP1: boxP1,
      boxP2: boxP2
    }

  }
  function reset(){
    	signature = [];
  }
  return {
    pressing: pressing,
    pressed: function(){return pressed},
    release: release,
    updateBoundary: updateBoundary,
    reset: reset,
    signature: function(){return signature}
  }

}

function encrypt_secret(json_url, passphrase){
	get_json(json_url, function(data){
		var content = JSON.stringify({"secret":encrypt(JSON.stringify(data), passphrase)});
		//console.log(content);
		var blob = new Blob([content], {type:'text/plain;charset=utf-8'})
		saveAs(blob, json_url.split('/').pop()+'.json');
    content = "var static_info = " + content;
    blob = new Blob([content], {type:'text/plain;charset=utf-8'})
    saveAs(blob, json_url.split('/').pop()+'.js');

	})
}

function decrypt_secret(json_url, passphrase, handle){
  function processing(data){
    //console.log(data)
    var content = decrypt(data['secret'], passphrase);
    if(!!content){
      try{
        var obj = JSON.parse(content);
        handle(obj);
      }catch(e){
        console.log(e);
      }
    }else{
      console.log('invalid passphrase!')
    }
  }
  typeof json_url === "object"? processing(json_url): get_json(json_url, processing);

}

function stroking_b64(stroke_arr){
  //var zip = JSZip();
  var data = stroke_arr.map(function(e){
    return btoa(String.fromCharCode.apply(null, [].concat.apply([], e.map(function(e){return [e.x,e.y]}))));
  });
  return data.join(';');
  
  // data.forEach(function(e,i,arr){
  //   zip.file(String(i+1), e, {binary:true, compression:"DEFLATE"})
  // });
  //zip.generateAsync({type:"string", compression: "DEFLATE"}).then(handle);

}
function b64_stroking(b64str){
  return b64str.split(';').map(function(e){
    return atob(e).split('').map(function(e,i){
      return e.charCodeAt(0);
    });
  })
}

</script>
    <script>
var static_info = {"secret":"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"};
var sheetId_enc = "de320223683b5d557a2d4d4aa3d502b4ab4474c5f9b7a05a9e782ec729bad93bU2FsdGVkX19mx2mGzdS9iBq1iWRTSEIciM9HlDRSK71H7xYr5iuI9B2lRGnwUPkgKknSy1m65pGnEXuGwB1zFA==";
var formId_enc = "796b586a9a036e5dd90d6fdb16bdc74cb82f5d0ec2102c05218aa5c4d25c548bU2FsdGVkX1+gCbMKm9sdeV12pu5c2iGH+rk5a8ow79mKQD7iMTndBwEK/5Y4tLUXoZuKUlaGhZ2+ucb7tZFF/CAwhYzTI2qLXvm4Pxm4nRs=";
var urlprefix_enc = "c9fe9f40a86385c498a2267f1c78a935853ab99e2d40844ae3ad94ce4aa36b3bU2FsdGVkX1+Qx+JWYXlCKs4FlflGKAV1wETBKYXHTVzdtCEPPZvpCwPsT7gge3p3";

</script>
  </head>
  <body>
    <div class="mdl-card mdl-shadow--2dp">
      <div class="mdl-card__title">
        <h2 class="mdl-card__title-text">Collect Data for Simple Signature Verification</h2>
      </div>
      <!--
      <div class="mdl-card__media">
      <img src="photo.jpg" width="220" height="140" border="0" alt="" style="padding:20px;">
      </div>
      -->
      <div class="mdl-card__supporting-text mdl-card--border">
        <form action="#"><a> To prevent abuse, input the passphrase posted on Moodle. </a>
          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
            <input class="mdl-textfield__input" id="input_passphrase" type="password">
            <label class="mdl-textfield__label" for="input_passphrase">Passphrase...</label>
          </div><a> Create your genuine signature or forge others&apos;. </a>
        </form>
      </div>
      <div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect mdl-card--border">
        <div class="mdl-tabs__tab-bar"><a class="mdl-tabs__tab is-active" href="#genuine-panel">Genuine    </a><a class="mdl-tabs__tab" href="#forged-panel">Forged </a></div>
        <div class="mdl-tabs__panel is-active" id="genuine-panel">
          <div class="mdl-card__supporting-text mdl-card--border">
            <!-- Colored FAB button-->
            <form action="#">
              <!-- <div class="">--><a> Fill in your info below for authentication</a>
              <!-- </div>-->
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <input class="mdl-textfield__input" id="input_name" type="text">
                <label class="mdl-textfield__label" for="input_name">Your Surname, First name...</label>
              </div>
              <!-- </form>-->
              <!-- Numeric Textfield with Floating Label-->
              <!-- <form action="#">-->
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <input class="mdl-textfield__input" id="input_sid" type="text" pattern="[0-9]*">
                <label class="mdl-textfield__label" for="input_sid">Student ID... </label><span class="mdl-textfield__error">Input is not a valid ID!</span>
              </div>
              <!-- </form>-->
              <!-- Numeric Textfield with Floating Label-->
              <!-- <form action="#">-->
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <input class="mdl-textfield__input" id="input_score" type="text" pattern="[0-9]*(.[0-9]*)?">
                <label class="mdl-textfield__label" for="input_score">Assignment 1 Score...  </label><span class="mdl-textfield__error">Input is not a number!</span>
              </div>
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <input class="mdl-textfield__input" id="input_label" type="text">
                <label class="mdl-textfield__label" for="input_label">Optional label...</label>
              </div>
            </form>
            <!-- Accent-colored raised button with ripple-->
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="button_upload_genuine">
              <!-- Rich Tooltip-->
              <div class="icon material-icons">cloud_upload</div>
              <div class="mdl-tooltip" data-mdl-for="button_upload_genuine">Upload <strong>genuine signature</strong></div>
            </button>
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="button_get_info">
              <!-- Rich Tooltip-->
              <div class="icon material-icons">info</div>
              <div class="mdl-tooltip" data-mdl-for="button_get_info">Get <strong>info</strong> of your dataset</div>
            </button>
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="button_download_all">
              <!-- Rich Tooltip-->
              <div class="icon material-icons">get_app</div>
              <div class="mdl-tooltip" data-mdl-for="button_download_all">Get <strong>All signatures </strong></div>
            </button>
          </div>
        </div>
        <div class="mdl-tabs__panel" id="forged-panel">
          <div class="mdl-card__supporting-text mdl-card--border">
            <form action="#"><a> Select a target and download signature to imitate (using auto-completion!) </a>
              <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <input class="mdl-textfield__input" id="input_target" type="text">
                <label class="mdl-textfield__label" for="input_target">Target&apos;s Surname, First Name...  </label>
              </div>
              <div id="image_container" style="width: 100%; height: 100%;"><img id="sig-image" width="255" height="127" style="width: 100%;"></div>
            </form>
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="button_download_target">
              <!-- Rich Tooltip-->
              <div class="icon material-icons">get_app</div>
              <div class="mdl-tooltip" data-mdl-for="button_download_target">Get <strong>signature  </strong></div>
            </button>
            <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="button_upload_forged">
              <!-- Rich Tooltip-->
              <div class="icon material-icons">cloud_upload</div>
              <div class="mdl-tooltip" data-mdl-for="button_upload_forged">Upload <strong>forged signature</strong></div>
            </button>
          </div>
        </div>
      </div>
      <!-- End of tabs-->
      <div class="mdl-card__supporting-text">
        <div class="mdl-card__supporting-text"><a id="status"></a></div>
        <div id="canvas_container" style="border: 1pt solid black; width: 100%;">
          <canvas id="sig-canvas" width="255" height="127" style="width: 100%;"> </canvas>
        </div>
      </div>
      <div class="mdl-card__actions">
        <div>
          <button class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" id="button_reset">
            <div class="icon material-icons">delete</div><a> Clear Canvas     </a>
          </button><span class="mdl-badge" id="badge_saved_count" data-badge="0">Saved</span>
          <!--
          <button id="button_add_canvas" class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored">
          <i class="icon material-icons">add</i>
          <div class="mdl-tooltip" data-mdl-for="button_add_canvas">
          Add <strong>canvas</strong> (not implemented)
          </div>
          </button>
          -->
          <div>
            <div id="container">
              <button class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" id="button_save">
                <div class="icon material-icons">assignment_returned       </div><a> Save Signatures to zip </a>
              </button>
            </div>
            <!--
            <div class="mdl-layout-spacer"></div>
            <i class="material-icons">event</i> 
            -->
          </div>
          <div class="mdl-js-snackbar mdl-snackbar" id="snack-toast">
            <div class="mdl-snackbar__text"></div>
            <button class="mdl-snackbar__action" type="button"></button>
          </div>
          <footer class="mdl-mini-footer">
            <div class="mdl-mini-footer__left-section">
              <div class="mdl-logo">COMP3314    </div>
              <ul class="mdl-mini-footer__link-list">
                <li><a href="tool/index.html" target="_blank">Tool      </a></li>
                <li><a href="instruction/index.html" target="_blank">Instruction</a></li>
              </ul>
            </div>
          </footer>
        </div>
        <!-- End of cards-->
        <script>
var saved = ['passphrase', 'name', 'sid', 'score', 'label', 'target'];
function saveCookie(){
	for(var i in saved){
  	var j = saved[i];
  	var p = $('#input_' + j).val();
  	if(!!p){
  		setCookie(j, p, 2);
	  }
  }
  console.log('Cookies saved.');
}

var name_list = {};
var signature_list = {}, stroking_list = {}
var forged_signature_list = {}, forged_stroking_list = {};
var app = {
	saved_count:0,
	names: name_list,
	genuine_sig: signature_list,
	genuine_stroke: stroking_list,
	forged_sig: forged_signature_list,
	forged_stroke: forged_stroking_list,
	labels: function(){
		return Object.keys(this.genuine_sig);
	},
	item: function(label, i){
		return {
			signature: this.genuine_sig[label][i],
			stroking: this.genuine_stroke[label][i],
			id: [label, i]
		}
	},
	badge: $("#badge_saved_count"),
	add_genuine: function(label, imgdata, stdata){
		if(!(label in this.genuine_sig)){
			this.genuine_sig[label] = [];
			this.genuine_stroke[label] = [];
		}
		this.genuine_sig[label].push(imgdata);
		this.genuine_stroke[label].push(stdata);
		this.saved_count ++;
		this.badge.attr('data-badge', String(this.saved_count));
	}
}
  var logger = new function(){
  	var ele = this.ele = $("#status");
  	var snack = this.snack = $("#snack-toast")[0];
  	console.log(ele[0], snack)
  	var _this = this;
  	this.log = function(msg){
  		(arguments.length <= 1 && typeof msg == 'string')? 
  			//snack.MaterialSnackbar.showSnackbar({message: msg, timeout:5000}):
  			ele.html(msg): 
  			console.log.apply(_this, arguments);
  	}
  	this.invalid_pass = function(){
  		this.log('Invalid passphrase!');
  	}
  	this.invalid_name = function(){
  		this.log('Invalid name, pls select from auto-completion!');
  	}
  }
  

function initUI(canvas){
  // var button = document.createElement('button');
  // var textNode = document.createTextNode('Save Signature!');
  // button.appendChild(textNode);
  // button.className = 'mdl-button mdl-js-button mdl-js-ripple-effect';
  // componentHandler.upgradeElement(button);
  // document.getElementById('container').appendChild(button);
  var button = "#button_save"
  $(button).click(function(){
  	var zip = new JSZip();
		zip.file("Readme.txt", "signatures (with hash-label) stored in signature/, size 256x128, PNG format\nstrokes stored in stroke/, 2-D array");
		var img = zip.folder("signature");
		var st = zip.folder("stroke");
		var n_img = 0;
		for(var label in signature_list){
			signature_list[label].forEach(function(e,i,arr){
				var s = stroking_list[label][i];
				var h = CryptoJS.SHA256(e).toString().substr(0,8);
				img.file(h +'-'+label+'.png', 
					e.split('base64,')[1], {base64: true});
				n_img++;
				var arr = s.map(function(e){return e.map(function(e){return [e.x,e.y]})});
				var arr = JSON.stringify(arr);
				st.file(h+'-'+label+'.json', arr);
			});
			
		}
		if(n_img == 0){
			logger.log('No uploaded signature to save in this session!');
			return;
		}
		//var imgURL = canvas.toDataURL()
		//img.file("signature.png", imgURL.split('base64,')[1], {base64: true});
		zip.generateAsync({type:"blob"	})
		.then(function(content) {
		    // see FileSaver.js
		    saveAs(content, "Genuine.zip");
		    logger.log(n_img + ' signatures saved to zip.');
		});
  });
  
  for(var i in saved){
  	var j = saved[i];
  	var p = getCookie(j);
  	//console.log(j, p);
  	if(!!p){
	  	$('#input_' + j).val(p);
	  }
  }

}

	

var sel = selector();
function update_namelist(){
	var passphrase = $("#input_passphrase").val().toUpperCase();
	//var secret_obj = 'info.json'; // stored in json
	var secret_obj = static_info;  // stored in js
	if(passphrase && !(passphrase in name_list)){
		decrypt_secret(secret_obj, passphrase, 
			function(info){
				
				name_list[passphrase] = info.name || info.students.map(function(e){return e[1]+', '+e[0]});
        logger.log('students info loaded', name_list[passphrase].length);
				$("#input_name").autocomplete({
					source: name_list[passphrase]
				});
				$("#input_target").autocomplete({
					source: name_list[passphrase]
				});
		}); // auto-completion
	}
}
  

	
	
	
$(function(){
	var canvas = document.getElementById('sig-canvas');
    var ctx = canvas.getContext('2d');
    var scaling = parseFloat($(canvas).attr('width'))/parseFloat($(canvas).css('width'));
    console.log('canvas scaling', scaling);
    ctx.strokeStyle = 'blue';
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round'
	initUI(canvas);
	
	$("#input_passphrase").focusout(update_namelist)
	$("#input_name").focus(update_namelist);
	$("#input_target").focus(update_namelist);
	
  
  // source image mouse control
  function release(e){
    var res = sel.release(e);
    window.blockMenuHeaderScroll = false;
    if(res == false){
      return;
    }
    //ctx.lineTo(res.boundary[0].x, res.boundary[0].y);
    //ctx.stroke();
    ctx.closePath();
  }
  function start(e){
  	var offsetX = Math.round(scaling * e.offsetX);
  	var offsetY = Math.round(scaling * e.offsetY);

  	if(sel.pressing(offsetX, offsetY)){
    ctx.beginPath();
    ctx.moveTo(offsetX, offsetY);
    window.blockMenuHeaderScroll = true;
  }
  }
  function move(e){
  	if(sel.pressed()){
  		var offsetX = Math.round(scaling * e.offsetX);
  	  var offsetY = Math.round(scaling * e.offsetY);
        sel.updateBoundary(offsetX, offsetY);
        ctx.lineTo(offsetX, offsetY);
        ctx.stroke();
    }
  }
  function reset(){
  	console.log(sel.signature())
  	sel.reset();
  	ctx.clearRect(0, 0, canvas.width, canvas.height);
  	logger.log('Canvas cleared!');
  }

  register(canvas, {
    'mousedown': function(e){
    	start(e);
    	move(e);
    },
    'touchstart': start,
    'mousemove': move,
    'touchmove': function(e){
    	if(window.blockMenuHeaderScroll){
	    		e.preventDefault();
	    }
    	var touch = e.targetTouches[0];
     //$("#status").html([touch.clientX>>0, touch.pageX>>0, touch.clientY>>0, touch.pageY>>0].join(','));
    	var mouseEvent = new MouseEvent("mousemove", {
		    clientX: touch.pageX,
		    clientY: touch.pageY
		  });
	  	canvas.dispatchEvent(mouseEvent);
    },
    'mouseup': release,
    'mouseout': release,
    'touchend': release,
    'dblclick': function(e){
      //console.log(e.offsetX, e.offsetY);
      reset();
    }
  });
  $("#button_reset").click(reset);
  $("#button_upload_genuine").click(function(){
  	var passphrase = $("#input_passphrase").val().toUpperCase();

  	var formId = decrypt(formId_enc, passphrase);
	if(!formId){
		logger.invalid_pass();
		return;
	}
	saveCookie();
	
	
    var stamp = getStamp();
    var score = $('#input_score').val();
    if(!score){
    	score = 0;
    }
    var label = $('#input_label').val();
    update_namelist();
    var student_name = $('#input_name').val();
    if(name_list[passphrase].indexOf(student_name) < 0){
    	logger.invalid_name();
    	return;
    }

    var id = [student_name, $('#input_sid').val(), 
      (parseFloat(score)*100)>>0].join(';');
    var id = CryptoJS.SHA256(id).toString().substr(0,8) + label; //encrypt(id, passphrase);
    logger.log('Saving and submitting data ...');
  	
  	var stroke_data = sel.signature()
  	//stroking_list[label].push(stroke_data);
  	var stroke_str = stroking_b64(stroke_data);
  	console.log('stroke string length', stroke_str.length);
  	submit_one(formId, id, 'genuine-strokearray', stroke_str, stamp, function(){
  		console.log('Genuine strokes submitted.', );
  	});
  	var image_data = canvas.toDataURL();
	console.log('dataurl length', image_data.length);
  	//signature_list[label].push(image_data);
  	submit_one(formId, id, 'genuine-dataurl', image_data, stamp, function(){
  		logger.log('Genuine signature submitted.');
  		
  	});
  	app.add_genuine(label, image_data, stroke_data);
  	
  });
  $("#button_download_target").click(function(){
		var passphrase = $("#input_passphrase").val().toUpperCase();

  	var sheetId = decrypt(sheetId_enc, passphrase);
		if(!sheetId){
			//console.log('invalid passphrase!')
			logger.invalid_pass();
			return;
		}
		update_namelist();
		var target_name = $('#input_target').val();
		var row = name_list[passphrase].indexOf(target_name);
    if(row < 0){
    	logger.invalid_name();
    	return;
    }
    saveCookie();
    row += 1;
	get_target(sheetId, row, 2, function(data){
		// handle data
		var dataurl = data.entry.gs$cell.$t;
		if(dataurl.indexOf('base64')<0){
			logger.log("No signature to imitate");
			$("#sig-image").attr('src', '');
			return;
		}
		$("#sig-image").attr('src', dataurl);
		logger.log('Target signature downloaded!');
	});

  });
$("#button_upload_forged").click(function(){
	var passphrase = $("#input_passphrase").val().toUpperCase();

  	var formId = decrypt(formId_enc, passphrase);
	if(!formId){
		//console.log('invalid passphrase!')
		logger.invalid_pass()
		return;
	}
	var target_name = $('#input_target').val();
	if(name_list[passphrase].indexOf(target_name) < 0){
    	logger.invalid_name();
    	return;
    }
	saveCookie();
	
    var stamp = getStamp();
    var id = target_name + ';'+ CryptoJS.SHA256($('#sig-image').attr('src')).toString().substr(0,8); //encrypt(id, passphrase);
    logger.log('Submitting data ...');
    
  	var stroke_data = sel.signature()
  	var stroke_str = stroking_b64(stroke_data);
  	console.log('stroke string length', stroke_str.length);
  	submit_one(formId, id, 'forged-strokearray', stroke_str, stamp, function(){
  		console.log('Forged strokes submitted.');
  	});
  	var image_data = canvas.toDataURL();
	console.log('dataurl length', image_data.length);
  	submit_one(formId, id, 'forged-dataurl', image_data, stamp, function(){
  		logger.log('Forged signature submitted.');
  	});

});
$("#button_download_all").click(function(){
    var passphrase = $("#input_passphrase").val().toUpperCase();
    var sheetId = decrypt(sheetId_enc, passphrase);
    var urlprefix = decrypt(urlprefix_enc, passphrase);
    if(!sheetId || !urlprefix){
      //console.log('invalid passphrase!')
      logger.invalid_pass();
      return;
    }
    update_namelist();
    var student_name = $('#input_name').val();
    if(name_list[passphrase].indexOf(student_name) < 0){
      logger.invalid_name();
      return;
    }
    var score = $('#input_score').val();
    if(!score){
      score = 0;
    }
    saveCookie();

    var id = [student_name, $('#input_sid').val(), 
      (parseFloat(score)*100)>>0].join(';');
    id = CryptoJS.SHA256(id).toString().substr(0,8);
    var stamp = CryptoJS.SHA256(getStamp()).toString().substr(0,8);


    var zip_url = urlprefix + id + '/svdata_' +
      student_name.replace(/ /g, '_').replace(/,/g, '') + '.zip?t=' + stamp;
    //console.log(zip_url)
    get_json(urlprefix + 'date', function(data){
      logger.log('Zip updated at ' + new Date(data));
    }, function(e){logger.log('Failed to download all signatures')});
    window.open(zip_url, '_blank');
    

});
$("#button_get_info").click(function(){
	var passphrase = $("#input_passphrase").val().toUpperCase();
  	var sheetId = decrypt(sheetId_enc, passphrase);
		if(!sheetId){
			//console.log('invalid passphrase!')
			logger.invalid_pass();
			return;
		}
		update_namelist();
		var student_name = $('#input_name').val();
		var row = name_list[passphrase].indexOf(student_name);
		if(row < 0){
    	logger.invalid_name();
    	return;
    }
    saveCookie();
    row += 1;
	get_target(sheetId, row, 1, function(data){
		// handle data
		var genuine_count = parseInt(data.entry.gs$cell.$t);
		get_target(sheetId, row, 3, function(data){
			var forged_count = parseInt(data.entry.gs$cell.$t);
			logger.log((genuine_count + forged_count) + ' signatures, '+genuine_count + ' genuine.');
		});

	});
		

});
	
}); // document ready
//$(window).on('unload', onExit);
</script>
      </div>
    </div>
  </body>
</html>
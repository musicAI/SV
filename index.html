<!DOCTYPE html>
<html>
<head>
	<title> Collect Data for Signature Verification </title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">

	<script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"
        integrity="sha384-lp4k1VRKPU9eBnPePjnJ9M2RF3i7PC30gXs70+elCVfgwLwx1tv5+ctxdtwxqZa7"
        crossorigin="anonymous"></script>
  <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="utils.js"></script>
  <script src="info.js"></script>
</head>
<body>
  <div class="mdl-card mdl-shadow--2dp">
	  <div class="mdl-card__title">
	    <h2 class="mdl-card__title-text">Collect Data for Simple Signature Verification</h2>
	  </div>
	  <!-- <div class="mdl-card__media">
	    <img src="photo.jpg" width="220" height="140" border="0" alt="" style="padding:20px;">
	  </div> -->

	  <div class="mdl-card__supporting-text mdl-card--border">
	  	<form action="#">
	  	  <a> Input the passphrase posted on moodle. </a>
		  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
		    <input class="mdl-textfield__input" type="password" id="input_passphrase">
		    <label class="mdl-textfield__label" for="input_passphrase">Passphrase...</label>
		  </div>
		  <a> Create your genuine signature or forge others'. </a>
		</form>
	  </div>
	  
	  
	  
		<div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect mdl-card--border">
		  <div class="mdl-tabs__tab-bar">
		      <a href="#genuine-panel" class="mdl-tabs__tab is-active">Genuine</a>
		      <a href="#forged-panel" class="mdl-tabs__tab">Forged</a>
		  </div>

		  <div class="mdl-tabs__panel is-active" id="genuine-panel">
		  	<div class="mdl-card__supporting-text mdl-card--border">
		  	<!-- Colored FAB button -->
				
		  	
					
				<form action="#">
				  <!-- <div class=""> -->
				  	<a> Fill in your info below </a>
				  <!-- </div> -->

				  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
				    <input class="mdl-textfield__input" type="text" id="input_name">
				    <label class="mdl-textfield__label" for="input_name">Your Name...</label>
				  </div>
				<!-- </form> -->
				<!-- Numeric Textfield with Floating Label -->
				<!-- <form action="#"> -->
				  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
				    <input class="mdl-textfield__input" type="text" pattern="[0-9]*" id="input_sid">
				    <label class="mdl-textfield__label" for="input_sid">Student ID...</label>
				    <span class="mdl-textfield__error">Input is not a valid ID!</span>
				  </div>
				<!-- </form> -->
				<!-- Numeric Textfield with Floating Label -->
				<!-- <form action="#"> -->
				  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
				    <input class="mdl-textfield__input" type="text" pattern="[0-9]*(\.[0-9]*)?" id="input_score">
				    <label class="mdl-textfield__label" for="input_score">Assignment 1 Score...</label>
				    <span class="mdl-textfield__error">Input is not a number!</span>
				  </div>
				</form>
				<!-- Accent-colored raised button with ripple -->
				<button id="button_upload_genuine" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
					<!-- Rich Tooltip -->
					<div class="icon material-icons">cloud_upload</div>
					<div class="mdl-tooltip" data-mdl-for="button_upload_genuine">
					Upload <strong>signature</strong>
					</div>
				</button>
			</div>
		    
		  </div>
		  
		  <div class="mdl-tabs__panel" id="forged-panel">
		  	<div class="mdl-card__supporting-text mdl-card--border">
		  	
			
			<form action="#">
			  
			  <a> Select a signature to forge </a>
			  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
			    <input class="mdl-textfield__input" type="text" id="input_target">
			    <label class="mdl-textfield__label" for="input_target">Target Name...</label>
			  </div>
			</form>
		    <!-- <ul class="mdl-list">
		    	<li class="mdl-list__item mdl-button mdl-js-button">
		    		<span class="mdl-list__item-primary-content">
					    <i class="material-icons mdl-list__item-icon">person</i>
					    Bryan Cranston
					</span>
		    	</li>
		    </ul> -->
		    <button id="button_upload_forged" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
		  	<!-- Rich Tooltip -->
				<div class="icon material-icons">cloud_upload</div>
				<div class="mdl-tooltip" data-mdl-for="button_upload_forged">
				Upload <strong>signature</strong>
				</div>
			</button>
			</div>

		  </div>

		</div> <!-- End of tabs -->

		<div class="mdl-card__supporting-text">
	  	
	  	<div id="canvas_container" style="border: 1pt solid black; width: 200px; height: 100px;">
		  		<canvas id="sig-canvas" width="200" height="100">
		  </div>
		  
	  </div>
	  <div class="mdl-card__actions">
	  	<div id="container"></div>
	    <a id="button_reset"class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
	      Clear Canvas
	    </a>
	    <button id="button_add_canvas" class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored">
		  <i class="icon material-icons">add</i>
		  <div class="mdl-tooltip" data-mdl-for="button_add_canvas">
			Add <strong>canvas</strong>
			</div>
		</button>
    <!-- <div class="mdl-layout-spacer"></div>
    <i class="material-icons">event</i> -->
	  </div>
	  <div class="mdl-card__supporting-text">
	  	<a id="status"></a>
	  </div>	

		<footer class="mdl-mini-footer">
		  <div class="mdl-mini-footer__left-section">
		    <div class="mdl-logo">COMP3314</div>
		    <ul class="mdl-mini-footer__link-list">
		      <li><a href="#">Machine Learning</a></li>
		      <li><a href="#">Instructions</a></li>
		    </ul>
		  </div>
		</footer>
  </div>  <!-- End of cards -->
  
	
	
	<script>
	  var saved = ['passphrase', 'name', 'sid', 'score'];
	  var formId_enc = "cdc858c0b42d8bbf6a5daef1f71ef0569617b056173329dd64cdae5a00ec1bc9U2FsdGVkX1+w2CNIwH/qu+2gOKtfRYmEQb3gckRQdgXkiywm8Nq0n725JFPvv48PqY+cZCHKkqbAR4efyb1DUjP0A/oSaTEoX2gL5u6UkTU=";
	  

		function initUI(canvas){
			var button = document.createElement('button');
		  var textNode = document.createTextNode('Save Signature!');
		  button.appendChild(textNode);
		  button.className = 'mdl-button mdl-js-button mdl-js-ripple-effect';
		  componentHandler.upgradeElement(button);
		  document.getElementById('container').appendChild(button);
		  $(button).click(function(){
		  	var zip = new JSZip();
				zip.file("Readme.txt", "Image stored in images/\n");
				var img = zip.folder("images");
				var imgURL = canvas.toDataURL()
				img.file("signature.png", imgURL.split('base64,')[1], {base64: true});
				zip.generateAsync({type:"blob"})
				.then(function(content) {
				    // see FileSaver.js
				    saveAs(content, "example.zip");
				});
		  });
		  
		  for(var i in saved){
		  	var j = saved[i];
		  	var p = getCookie(j);
		  	//console.log(j, p);
		  	if(!!p){
			  	$('#input_' + j).val(p);
			  }
		  }

		}

		function saveCookie(){
			console.log('saving cookies ...');
			for(var i in saved){
		  	var j = saved[i];
		  	var p = $('#input_' + j).val();
		  	if(!!p){
		  		setCookie(j, p, 2);
			  }
		  }
		}

		var sel = selector();
	  

		var name_list = {};
		
		
	$(function(){
		var canvas = document.getElementById('sig-canvas');
	  var ctx = canvas.getContext('2d');
	  ctx.strokeStyle = 'blue';
		initUI(canvas);
		$("#input_name").focus(function(){
			var passphrase = $("#input_passphrase").val().toUpperCase();
			//var secret_obj = 'info.json'; // stored in json
			var secret_obj = static_info;  // stored in js
			if(passphrase && !(passphrase in name_list)){
				decrypt_secret(secret_obj, passphrase, 
					function(info){
						console.log('students info loaded');
						name_list[passphrase] = info.students.map(function(e){return e[1]+', '+e[0]});
						$("#input_name").autocomplete({
							source: name_list[passphrase]
						});
						$("#input_target").autocomplete({
							source: name_list[passphrase]
						});
				}); // auto-completion
			}
		})
		
	  
	  // source image mouse control
	  function release(e){
	    var res = sel.release(e);
	    window.blockMenuHeaderScroll = false;
	    if(res == false){
	      return;
	    }
	    //ctx.lineTo(res.boundary[0].x, res.boundary[0].y);
	    //ctx.stroke();
	    ctx.closePath();
	  }
	  function start(e){
	  	if(sel.pressing(e)){
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
        window.blockMenuHeaderScroll = true;
      }
	  }
	  function move(e){
	  	if(sel.pressed()){
	        sel.updateBoundary(e.offsetX, e.offsetY);
	        ctx.lineTo(e.offsetX, e.offsetY);
	        ctx.stroke();
	    }
	  }
	  function reset(){
	  	console.log(sel.signature())
	  	sel.reset();
	  	ctx.clearRect(0, 0, canvas.width, canvas.height);
	  }

	  register(canvas, {
	    'mousedown': function(e){
	    	start(e);
	    	move(e);
	    },
	    'touchstart': start,
	    'mousemove': move,
	    'touchmove': function(e){
	    	if(window.blockMenuHeaderScroll){
		    		e.preventDefault();
		    }
	    	var touch = e.targetTouches[0];
	     //$("#status").html([touch.clientX>>0, touch.pageX>>0, touch.clientY>>0, touch.pageY>>0].join(','));
	    	var mouseEvent = new MouseEvent("mousemove", {
			    clientX: touch.pageX,
			    clientY: touch.pageY
			  });
		  	canvas.dispatchEvent(mouseEvent);
	    },
	    'mouseup': release,
	    'mouseout': release,
	    'touchend': release,
	    'dblclick': function(e){
	      //console.log(e.offsetX, e.offsetY);
	      reset();
	    }
	  });
	  $("#button_reset").click(reset);
	  $("#button_upload_genuine").click(function(){
	  	var passphrase = $("#input_passphrase").val().toUpperCase();

	  	var formId = decrypt(formId_enc, passphrase);
		if(!formId){
			console.log('invalid passphrase!')
			$("#status").html('invalid passphrase!')
			return;
		}
		saveCookie();
		$("#status").html('Submitting data ...');
		var image_data = canvas.toDataURL();
		console.log('data length', image_data.length);
		var d = new Date();
	    var stamp = d.toUTCString();
	    var score = $('#input_score').val();
	    if(!score){
	    	score = 0;
	    }
	    var id = [$('#input_name').val(), $('#input_sid').val(), 
	      (parseFloat(score)*100)>>0].join(';');
	    var id = encrypt(id, passphrase);

	  	submit_one(formId, id, 'genuine-dataurl', image_data, stamp);
	  });
	}); // document ready
	//$(window).on('unload', onExit);
  
	</script>


</body>

</html>
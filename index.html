<!DOCTYPE html>
<html>
<head>
	<title> Collect Data for Signature Verification </title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">

	<script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"
        integrity="sha384-lp4k1VRKPU9eBnPePjnJ9M2RF3i7PC30gXs70+elCVfgwLwx1tv5+ctxdtwxqZa7"
        crossorigin="anonymous"></script>
  <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="utils.js"></script>
  <script src="info.js"></script>
</head>
<body>
  <div class="mdl-card mdl-shadow--2dp">
	  <div class="mdl-card__title">
	    <h2 class="mdl-card__title-text">Collect Data for Simple Signature Verification</h2>
	  </div>
	  <!-- <div class="mdl-card__media">
	    <img src="photo.jpg" width="220" height="140" border="0" alt="" style="padding:20px;">
	  </div> -->

	  <div class="mdl-card__supporting-text mdl-card--border">
	  	<form action="#">
	  	  <a> To prevent abuse, input the passphrase posted on Moodle. </a>
		  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
		    <input class="mdl-textfield__input" type="password" id="input_passphrase">
		    <label class="mdl-textfield__label" for="input_passphrase">Passphrase...</label>
		  </div>
		  <a> Create your genuine signature or forge others'. </a>
		</form>
	  </div>
	  
	  
	  
		<div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect mdl-card--border">
		  <div class="mdl-tabs__tab-bar">
		      <a href="#genuine-panel" class="mdl-tabs__tab is-active">Genuine</a>
		      <a href="#forged-panel" class="mdl-tabs__tab">Forged</a>
		  </div>

		  <div class="mdl-tabs__panel is-active" id="genuine-panel">
		  	<div class="mdl-card__supporting-text mdl-card--border">
		  	<!-- Colored FAB button -->
					
				<form action="#">
				  <!-- <div class=""> -->
				  	<a> Fill in your info below for authentication</a>
				  <!-- </div> -->

				  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
				    <input class="mdl-textfield__input" type="text" id="input_name">
				    <label class="mdl-textfield__label" for="input_name">Your Surname, First name...</label>
				  </div>
				<!-- </form> -->
				<!-- Numeric Textfield with Floating Label -->
				<!-- <form action="#"> -->
				  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
				    <input class="mdl-textfield__input" type="text" pattern="[0-9]*" id="input_sid">
				    <label class="mdl-textfield__label" for="input_sid">Student ID...</label>
				    <span class="mdl-textfield__error">Input is not a valid ID!</span>
				  </div>
				<!-- </form> -->
				<!-- Numeric Textfield with Floating Label -->
				<!-- <form action="#"> -->
				  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
				    <input class="mdl-textfield__input" type="text" pattern="[0-9]*(\.[0-9]*)?" id="input_score">
				    <label class="mdl-textfield__label" for="input_score">Assignment 1 Score...</label>
				    <span class="mdl-textfield__error">Input is not a number!</span>
				  </div>
				  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
				    <input class="mdl-textfield__input" type="text" id="input_label">
				    <label class="mdl-textfield__label" for="input_label">Optional label...</label>
				  </div>
				</form>
				</form>
				<!-- Accent-colored raised button with ripple -->
				<button id="button_upload_genuine" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
					<!-- Rich Tooltip -->
					<div class="icon material-icons">cloud_upload</div>
					<div class="mdl-tooltip" data-mdl-for="button_upload_genuine">
					Upload <strong>genuine signature</strong>
					</div>
				</button>
				<button id="button_get_info" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
					<!-- Rich Tooltip -->
					<div class="icon material-icons">info</div>
					<div class="mdl-tooltip" data-mdl-for="button_get_info">
					Get <strong>info</strong> of your dataset
					</div>
				</button>
			</div>
		    
		  </div>
		  
		  <div class="mdl-tabs__panel" id="forged-panel">
		  	<div class="mdl-card__supporting-text mdl-card--border">
		  	
			
			<form action="#">
			  
			  <a> Select a target and download signature to imitate (using auto-completion!)</a>
			  <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
			    <input class="mdl-textfield__input" type="text" id="input_target">
			    <label class="mdl-textfield__label" for="input_target">Target's Surname, First Name...</label>
			  </div>
			  <div id="image_container" style="width: 100%; height: 100%;">
		  		<img id="sig-image" width="255" height="127" style="width: 100%;">
		    </div>
			</form>
			
		  <button id="button_download_target" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
					<!-- Rich Tooltip -->
					<div class="icon material-icons">get_app</div>
					<div class="mdl-tooltip" data-mdl-for="button_download_target">
					Get <strong>signature</strong>
					</div>
			</button>
		  <button id="button_upload_forged" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
		  	<!-- Rich Tooltip -->
				<div class="icon material-icons">cloud_upload</div>
				<div class="mdl-tooltip" data-mdl-for="button_upload_forged">
				Upload <strong>forged signature</strong>
				</div>
			</button>
			</div>

		  </div>

		</div> <!-- End of tabs -->

		<div class="mdl-card__supporting-text">
			<div class="mdl-card__supporting-text">
	  	<a id="status"></a>
	  	</div>	
	  	
	  	<div id="canvas_container" style="border: 1pt solid black; width: 100%; height: 100%;">
		  		<canvas id="sig-canvas" width="255" height="127" style="width: 100%; height: 100%;"></canvas>
		  </div>
		  
	  </div>
	  <div class="mdl-card__actions">

	  	<div id="container"></div>
	    <button id="button_reset" class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
	      Clear Canvas
	    </button>
	    <button id="button_add_canvas" class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored">
		  <i class="icon material-icons">add</i>
		  <div class="mdl-tooltip" data-mdl-for="button_add_canvas">
			Add <strong>canvas</strong> (not implemented)
			</div>
		</button>
    <!-- <div class="mdl-layout-spacer"></div>
    <i class="material-icons">event</i> -->
	  </div>
	  

		<footer class="mdl-mini-footer">
		  <div class="mdl-mini-footer__left-section">
		    <div class="mdl-logo">COMP3314</div>
		    <ul class="mdl-mini-footer__link-list">
		      <li><a href="#">Machine Learning</a></li>
		      <li><a href="#">Instructions</a></li>
		    </ul>
		  </div>
		</footer>
  </div>  <!-- End of cards -->
  
	
	
	<script>
	  var saved = ['passphrase', 'name', 'sid', 'score', 'label', 'target'];
	  function saveCookie(){
			for(var i in saved){
		  	var j = saved[i];
		  	var p = $('#input_' + j).val();
		  	if(!!p){
		  		setCookie(j, p, 2);
			  }
		  }
		  console.log('Cookies saved.');
		}
	  var formId_enc = "cdc858c0b42d8bbf6a5daef1f71ef0569617b056173329dd64cdae5a00ec1bc9U2FsdGVkX1+w2CNIwH/qu+2gOKtfRYmEQb3gckRQdgXkiywm8Nq0n725JFPvv48PqY+cZCHKkqbAR4efyb1DUjP0A/oSaTEoX2gL5u6UkTU=";
	  var sheetId_enc = "b5e85b633fa5f51892b1d107a8bf0505b9c9a3bf2ba1c6e6ea26f893e9219617U2FsdGVkX1/MFIIvTYyEQFr90Uj7Gs0N0iJcGYgD20LVCWrVik6han9ccZ9Xmpq2UqYkRXg03j0PHnZZnTXXxA==";

	  var name_list = {};
	  var signature_list = {}, stroking_list = {}
	  var forged_signature_list = {}, forged_stroking_list = {};
	  var app = {
	  	names: name_list,
	  	genuine_sig: signature_list,
	  	genuine_stroke: stroking_list,
	  	forged_sig: forged_signature_list,
	  	forged_stroke: forged_stroking_list,
	  	labels: function(){
	  		return Object.keys(this.genuine_sig);
	  	},
	  	item: function(label, i){
	  		return {
	  			signature: this.genuine_sig[label][i],
	  			stroking: this.genuine_stroke[label][i],
	  			id: [label, i]
	  		}
	  	}
	  }
	  var logger = new function(){
	  	var ele = this.ele = $("#status");
	  	var _this = this;
	  	this.log = function(msg){
	  		(arguments.length <= 1 && typeof msg == 'string')? ele.html(msg): console.log.apply(_this, arguments);
	  	}
	  	this.invalid_pass = function(){
	  		this.log('Invalid passphrase!');
	  	}
	  	this.invalid_name = function(){
	  		this.log('Invalid name, pls select from auto-completion!');
	  	}
	  }
	  

		function initUI(canvas){
			var button = document.createElement('button');
		  var textNode = document.createTextNode('Save Signature!');
		  button.appendChild(textNode);
		  button.className = 'mdl-button mdl-js-button mdl-js-ripple-effect';
		  componentHandler.upgradeElement(button);
		  document.getElementById('container').appendChild(button);
		  $(button).click(function(){
		  	var zip = new JSZip();
				zip.file("Readme.txt", "signatures (with hash-label) stored in signature/, size 256x128, PNG format\nstrokes stored in stroke/, 2-D array");
				var img = zip.folder("signature");
				var st = zip.folder("stroke");
				var n_img = 0;
				for(var label in signature_list){
					signature_list[label].forEach(function(e,i,arr){
						var s = stroking_list[label][i];
						var h = CryptoJS.SHA256(e).toString().substr(0,8);
						img.file(h +'-'+label+'.png', 
							e.split('base64,')[1], {base64: true});
						n_img++;
						var arr = s.map(function(e){return e.map(function(e){return [e.x,e.y]})});
						var arr = JSON.stringify(arr);
						st.file(h+'-'+label+'.json', arr);
					});
					
				}
				if(n_img == 0){
					logger.log('No uploaded signature to save in this session!');
					return;
				}
				//var imgURL = canvas.toDataURL()
				//img.file("signature.png", imgURL.split('base64,')[1], {base64: true});
				zip.generateAsync({type:"blob"	})
				.then(function(content) {
				    // see FileSaver.js
				    saveAs(content, "Genuine.zip");
				    logger.log(n_img + ' signatures saved to zip.');
				});
		  });
		  
		  for(var i in saved){
		  	var j = saved[i];
		  	var p = getCookie(j);
		  	//console.log(j, p);
		  	if(!!p){
			  	$('#input_' + j).val(p);
			  }
		  }

		}

		

	var sel = selector();
	function update_namelist(){
		var passphrase = $("#input_passphrase").val().toUpperCase();
		//var secret_obj = 'info.json'; // stored in json
		var secret_obj = static_info;  // stored in js
		if(passphrase && !(passphrase in name_list)){
			decrypt_secret(secret_obj, passphrase, 
				function(info){
					logger.log('students info loaded', info.students.length);
					name_list[passphrase] = info.students.map(function(e){return e[1]+', '+e[0]});
					$("#input_name").autocomplete({
						source: name_list[passphrase]
					});
					$("#input_target").autocomplete({
						source: name_list[passphrase]
					});
			}); // auto-completion
		}
	}
	  

		
		
		
	$(function(){
		var canvas = document.getElementById('sig-canvas');
	    var ctx = canvas.getContext('2d');
	    var scaling = parseFloat($(canvas).attr('width'))/parseFloat($(canvas).css('width'));
	    console.log('canvas scaling', scaling);
	    ctx.strokeStyle = 'blue';
	    ctx.lineWidth = 2;
	    ctx.lineJoin = 'round'
		initUI(canvas);
		
		$("#input_passphrase").focusout(update_namelist)
		$("#input_name").focus(update_namelist);
		$("#input_target").focus(update_namelist);
		
	  
	  // source image mouse control
	  function release(e){
	    var res = sel.release(e);
	    window.blockMenuHeaderScroll = false;
	    if(res == false){
	      return;
	    }
	    //ctx.lineTo(res.boundary[0].x, res.boundary[0].y);
	    //ctx.stroke();
	    ctx.closePath();
	  }
	  function start(e){
	  	var offsetX = Math.round(scaling * e.offsetX);
	  	var offsetY = Math.round(scaling * e.offsetY);

	  	if(sel.pressing(offsetX, offsetY)){
        ctx.beginPath();
        ctx.moveTo(offsetX, offsetY);
        window.blockMenuHeaderScroll = true;
      }
	  }
	  function move(e){
	  	if(sel.pressed()){
	  		var offsetX = Math.round(scaling * e.offsetX);
	  	  var offsetY = Math.round(scaling * e.offsetY);
	        sel.updateBoundary(offsetX, offsetY);
	        ctx.lineTo(offsetX, offsetY);
	        ctx.stroke();
	    }
	  }
	  function reset(){
	  	console.log(sel.signature())
	  	sel.reset();
	  	ctx.clearRect(0, 0, canvas.width, canvas.height);
	  	logger.log('Canvas cleared!');
	  }

	  register(canvas, {
	    'mousedown': function(e){
	    	start(e);
	    	move(e);
	    },
	    'touchstart': start,
	    'mousemove': move,
	    'touchmove': function(e){
	    	if(window.blockMenuHeaderScroll){
		    		e.preventDefault();
		    }
	    	var touch = e.targetTouches[0];
	     //$("#status").html([touch.clientX>>0, touch.pageX>>0, touch.clientY>>0, touch.pageY>>0].join(','));
	    	var mouseEvent = new MouseEvent("mousemove", {
			    clientX: touch.pageX,
			    clientY: touch.pageY
			  });
		  	canvas.dispatchEvent(mouseEvent);
	    },
	    'mouseup': release,
	    'mouseout': release,
	    'touchend': release,
	    'dblclick': function(e){
	      //console.log(e.offsetX, e.offsetY);
	      reset();
	    }
	  });
	  $("#button_reset").click(reset);
	  $("#button_upload_genuine").click(function(){
	  	var passphrase = $("#input_passphrase").val().toUpperCase();

	  	var formId = decrypt(formId_enc, passphrase);
		if(!formId){
			logger.invalid_pass();
			return;
		}
		saveCookie();
		
		
		var d = new Date();
	    var stamp = d.toUTCString();
	    var score = $('#input_score').val();
	    if(!score){
	    	score = 0;
	    }
	    var label = $('#input_label').val();
	    update_namelist();
	    var student_name = $('#input_name').val();
	    if(name_list[passphrase].indexOf(student_name) < 0){
	    	logger.invalid_name();
	    	return;
	    }

	    var id = [student_name, $('#input_sid').val(), 
	      (parseFloat(score)*100)>>0].join(';');
	    var id = CryptoJS.SHA256(id).toString().substr(0,8) + label; //encrypt(id, passphrase);
	    logger.log('Saving and submitting data ...');
	    if(!(label in signature_list)){
	  			signature_list[label] = [];
	  			stroking_list[label] = [];
	  	}
	  	
	  	var stroke_data = sel.signature()
	  	stroking_list[label].push(stroke_data);
	  	var stroke_str = stroking_b64(stroke_data);
	  	console.log('stroke string length', stroke_str.length);
	  	submit_one(formId, id, 'genuine-strokearray', stroke_str, stamp, function(){
	  		console.log('Genuine strokes submitted.', );
	  	});
	  	var image_data = canvas.toDataURL();
		console.log('dataurl length', image_data.length);
	  	signature_list[label].push(image_data);
	  	submit_one(formId, id, 'genuine-dataurl', image_data, stamp, function(){
	  		logger.log('Genuine signature submitted.');
	  		
	  	});
	  	
	  });
		$("#button_download_target").click(function(){
			var passphrase = $("#input_passphrase").val().toUpperCase();

	  	var sheetId = decrypt(sheetId_enc, passphrase);
			if(!sheetId){
				//console.log('invalid passphrase!')
				logger.invalid_pass();
				return;
			}
			update_namelist();
			var target_name = $('#input_target').val();
			var row = name_list[passphrase].indexOf(target_name);
	    if(row < 0){
	    	logger.invalid_name();
	    	return;
	    }
	    saveCookie();
	    row += 1;
			get_target(sheetId, row, 2, function(data){
				// handle data
				var dataurl = data.entry.gs$cell.$t;
				if(dataurl.indexOf('base64')<0){
					logger.log("No signature to imitate");
					$("#sig-image").attr('src', '');
					return;
				}
				$("#sig-image").attr('src', dataurl);
				logger.log('Target signature downloaded!');
			});

		});
    $("#button_upload_forged").click(function(){
    	var passphrase = $("#input_passphrase").val().toUpperCase();

	  	var formId = decrypt(formId_enc, passphrase);
		if(!formId){
			//console.log('invalid passphrase!')
			logger.invalid_pass()
			return;
		}
		var target_name = $('#input_target').val();
		if(name_list[passphrase].indexOf(target_name) < 0){
	    	logger.invalid_name();
	    	return;
	    }
		saveCookie();
		
		var d = new Date();
	    var stamp = d.toUTCString();
	    var id = target_name + ';'+ CryptoJS.SHA256($('#sig-image').attr('src')).toString().substr(0,8); //encrypt(id, passphrase);
	    logger.log('Submitting data ...');
	    
	  	var stroke_data = sel.signature()
	  	var stroke_str = stroking_b64(stroke_data);
	  	console.log('stroke string length', stroke_str.length);
	  	submit_one(formId, id, 'forged-strokearray', stroke_str, stamp, function(){
	  		console.log('Forged strokes submitted.');
	  	});
	  	var image_data = canvas.toDataURL();
		console.log('dataurl length', image_data.length);
	  	submit_one(formId, id, 'forged-dataurl', image_data, stamp, function(){
	  		logger.log('Forged signature submitted.');
	  	});

    });
    $("#button_get_info").click(function(){
    	var passphrase = $("#input_passphrase").val().toUpperCase();
	  	var sheetId = decrypt(sheetId_enc, passphrase);
			if(!sheetId){
				//console.log('invalid passphrase!')
				logger.invalid_pass();
				return;
			}
			update_namelist();
			var student_name = $('#input_name').val();
			var row = name_list[passphrase].indexOf(student_name);
			if(row < 0){
	    	logger.invalid_name();
	    	return;
	    }
	    saveCookie();
	    row += 1;
		get_target(sheetId, row, 1, function(data){
			// handle data
			var genuine_count = parseInt(data.entry.gs$cell.$t);
			get_target(sheetId, row, 3, function(data){
				var forged_count = parseInt(data.entry.gs$cell.$t);
				logger.log((genuine_count + forged_count) + ' signatures, '+genuine_count + ' genuine.');
			});

		});
			

    });
		
	}); // document ready
	//$(window).on('unload', onExit);
  
	</script>


</body>

</html>